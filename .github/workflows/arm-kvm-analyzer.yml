name: ARM KVM Weekly Analyzer

on:
  schedule:
    - cron: '0 1 * * 1'  # æ¯å‘¨ä¸€ UTC 01:00 = ä¸œå…«åŒº 09:00
  workflow_dispatch:
    inputs:
      days_back:
        description: 'åˆ†æè¿‡å»å¤šå°‘å¤©çš„é‚®ä»¶'
        required: false
        default: '7'
        type: string
      send_notifications:
        description: 'æ˜¯å¦å‘é€é€šçŸ¥'
        required: false
        default: true
        type: boolean

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: "arm-kvm-analyzer"
  cancel-in-progress: false

jobs:
  analyze-and-deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸš€ ç­¾å‡ºä»£ç 
      uses: actions/checkout@v4
    
    - name: ğŸ è®¾ç½®Pythonç¯å¢ƒ
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
        cache: 'pip'
    
    - name: ğŸ“¦ å®‰è£…ä¾èµ–
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install markdown>=3.5.0 click>=8.1.7
    
    - name: âš™ï¸ é…ç½®Git
      run: |
        git config --global user.name "ARM KVM Analyzer Bot"
        git config --global user.email "analyzer@arm-kvm-bot.github.io"
    
    - name: ğŸ“§ è¿è¡ŒARM KVMé‚®ä»¶åˆ†æ
      env:
        OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        AI_PROVIDER: openai
        ENABLE_EMAIL: true
        EMAIL_USER: ${{ secrets.EMAIL_USER }}
        EMAIL_PASSWORD: ${{ secrets.EMAIL_PASSWORD }}
        EMAIL_RECIPIENTS: ${{ vars.EMAIL_RECIPIENTS || secrets.EMAIL_RECIPIENTS }}
        SMTP_SERVER: ${{ vars.SMTP_SERVER || 'smtp.gmail.com' }}
        SMTP_PORT: ${{ vars.SMTP_PORT || '587' }}
        ENABLE_LARK: ${{ vars.ENABLE_LARK || 'false' }}
        LARK_WEBHOOK_URL: ${{ secrets.LARK_WEBHOOK_URL }}
        LARK_WEBHOOK_SECRET: ${{ secrets.LARK_WEBHOOK_SECRET }}
        ENABLE_TELEGRAM: ${{ vars.ENABLE_TELEGRAM || 'false' }}
        TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
        TELEGRAM_CHAT_ID: ${{ vars.TELEGRAM_CHAT_ID }}
        DEFAULT_LANGUAGE: zh
        VERIFY_COMPLETENESS: true
        DEBUG: false
        TZ: Asia/Shanghai
      run: |
        sudo timedatectl set-timezone Asia/Shanghai
        DAYS_BACK="${{ github.event.inputs.days_back || '7' }}"
        echo "ğŸ“… åˆ†æè¿‡å» ${DAYS_BACK} å¤©çš„é‚®ä»¶"
        END_DATE=$(date +%Y-%m-%d)
        START_DATE=$(date -d "${DAYS_BACK} days ago" +%Y-%m-%d)
        echo "ğŸ•’ åˆ†ææ—¶é—´èŒƒå›´: ${START_DATE} åˆ° ${END_DATE}"
        echo "ğŸŒ å½“å‰ä¸œå…«åŒºæ—¶é—´: $(TZ=Asia/Shanghai date)"
        ANALYZE_CMD="python analyze.py main --since ${START_DATE} --until ${END_DATE} --output results --language zh --verify-completeness"
        if [ "${{ github.event.inputs.send_notifications }}" = "true" ] || [ "${{ github.event_name }}" = "schedule" ]; then
          ANALYZE_CMD="$ANALYZE_CMD --send-notifications"
          echo "ğŸ“¬ å°†å‘é€é€šçŸ¥åˆ°é…ç½®çš„å¹³å°"
        fi
        echo "ğŸš€ æ‰§è¡Œå‘½ä»¤: $ANALYZE_CMD"
        $ANALYZE_CMD
    
    - name: ğŸŒ ç”ŸæˆHTMLæŠ¥å‘Šå’ŒGitHub Pageséƒ¨ç½²
      run: |
        LATEST_DIR=$(find results -name "20*" -type d | sort | tail -1)
        if [ -z "$LATEST_DIR" ]; then
          echo "âŒ æœªæ‰¾åˆ°åˆ†æç»“æœç›®å½•"
          exit 1
        fi
        echo "ğŸ“ æ‰¾åˆ°ç»“æœç›®å½•: $LATEST_DIR"
        mkdir -p docs/reports
        DATE_DIR=$(basename "$LATEST_DIR")
        cp -r "$LATEST_DIR" "docs/reports/$DATE_DIR"
        python html_generator.py --results-dir "$LATEST_DIR" --github-repo "https://onlinefchen.github.io/kvmarm-robot"
        if [ -f "$LATEST_DIR/report.html" ]; then
          cp "$LATEST_DIR/report.html" "docs/reports/$DATE_DIR/index.html"
          echo "âœ… HTMLæŠ¥å‘Šå·²å¤åˆ¶åˆ°GitHub Pagesç›®å½•"
        fi
    
    - name: ğŸ“ åˆ›å»ºGitHub Pagesä¸»é¡µ
      run: |
        cat > docs/index.html << 'MAIN_PAGE'
<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ARM KVM é‚®ä»¶åˆ—è¡¨åˆ†ææŠ¥å‘Š</title>
    <style>
        body { font-family: 'PingFang SC', 'Microsoft YaHei', sans-serif; margin: 0; padding: 20px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; }
        .container { max-width: 1000px; margin: 0 auto; background: white; border-radius: 15px; box-shadow: 0 20px 60px rgba(0,0,0,0.1); overflow: hidden; }
        .header { background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%); color: white; padding: 3rem 2rem; text-align: center; }
        .header h1 { font-size: 2.5rem; margin: 0 0 0.5rem 0; font-weight: 300; }
        .content { padding: 2rem; }
        .report-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(350px, 1fr)); gap: 1.5rem; margin: 2rem 0; }
        .report-card { border: 1px solid #e0e0e0; border-radius: 12px; padding: 1.5rem; background: #f8f9fa; transition: transform 0.3s ease, box-shadow 0.3s ease; }
        .report-card:hover { transform: translateY(-5px); box-shadow: 0 10px 30px rgba(0,0,0,0.1); }
        .report-card h3 { color: #2c3e50; margin-top: 0; }
        .report-links a { display: inline-block; margin: 0.25rem 0.5rem 0.25rem 0; padding: 0.5rem 1rem; background: #3498db; color: white; text-decoration: none; border-radius: 6px; transition: background 0.3s ease; }
        .report-links a:hover { background: #2980b9; }
        .footer { background: #2c3e50; color: white; padding: 2rem; text-align: center; }
        .stats { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 1.5rem; border-radius: 10px; margin: 1.5rem 0; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ“Š ARM KVM é‚®ä»¶åˆ—è¡¨åˆ†ææŠ¥å‘Š</h1>
            <p>è‡ªåŠ¨åŒ–æŠ€æœ¯åˆ†æ â€¢ æ¯å‘¨æ›´æ–° â€¢ AIé©±åŠ¨</p>
        </div>
        <div class="content">
            <div class="stats">
                <h3>ğŸ“ˆ ç³»ç»ŸçŠ¶æ€</h3>
                <p>ğŸ¤– è‡ªåŠ¨åˆ†æARM KVMé‚®ä»¶åˆ—è¡¨ï¼Œæ¯å‘¨ä¸€ä¸œå…«åŒºä¸Šåˆ9ç‚¹æ›´æ–°</p>
                <p>ğŸ”— <strong>é‚®ä»¶å½’æ¡£</strong>: <a href="https://lore.kernel.org/kvmarm/" style="color: #fff;">lore.kernel.org/kvmarm</a></p>
MAIN_PAGE
        echo "                <p>â° <strong>æœ€åæ›´æ–°</strong>: $(TZ=Asia/Shanghai date '+%Y-%m-%d %H:%M:%S %Z')</p>" >> docs/index.html
        cat >> docs/index.html << 'MAIN_PAGE2'
            </div>
            <div class="report-grid" id="reportGrid">
MAIN_PAGE2
        for report_dir in docs/reports/*/; do
          if [ -d "$report_dir" ]; then
            date=$(basename "$report_dir")
            cat >> docs/index.html << REPORT_CARD
                <div class="report-card">
                    <h3>ğŸ“… $date</h3>
                    <p>ARM KVMæŠ€æœ¯åŠ¨æ€å’Œå¼€å‘åˆ†æ</p>
                    <div class="report-links">
REPORT_CARD
            if [ -f "$report_dir/index.html" ]; then
              echo "                        <a href=\"reports/$date/\">ğŸ“± æŸ¥çœ‹æŠ¥å‘Š</a>" >> docs/index.html
            fi
            if [ -f "$report_dir/analysis_report_zh.md" ]; then
              echo "                        <a href=\"reports/$date/analysis_report_zh.md\">ğŸ“„ Markdown</a>" >> docs/index.html
            fi
            if [ -f "$report_dir/statistics.json" ]; then
              echo "                        <a href=\"reports/$date/statistics.json\">ğŸ“Š æ•°æ®</a>" >> docs/index.html
            fi
            echo "                    </div>" >> docs/index.html
            echo "                </div>" >> docs/index.html
          fi
        done
        cat >> docs/index.html << 'MAIN_PAGE_END'
            </div>
        </div>
        <div class="footer">
            <p>ğŸ¤– ç”±ARM KVMåˆ†ææœºå™¨äººè‡ªåŠ¨ç”Ÿæˆ</p>
            <p>ğŸ”— <a href="https://github.com/onlinefchen/kvmarm-robot" style="color: #3498db;">é¡¹ç›®æºç </a></p>
        </div>
    </div>
</body>
</html>
MAIN_PAGE_END
        echo "ğŸŒ GitHub Pagesç»“æ„å·²å‡†å¤‡å®Œæˆ"
    
    - name: ğŸ“¤ ä¸Šä¼ åˆ†æç»“æœ
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: arm-kvm-analysis-${{ github.run_number }}
        path: results/
        retention-days: 30
    
    - name: ğŸš€ é…ç½®GitHub Pages
      uses: actions/configure-pages@v4
    
    - name: ğŸ“¦ ä¸Šä¼ åˆ°GitHub Pages
      uses: actions/upload-pages-artifact@v3
      with:
        path: './docs'
    
    - name: ğŸŒ éƒ¨ç½²åˆ°GitHub Pages
      id: deployment
      uses: actions/deploy-pages@v4
    
    - name: ğŸ“¬ å‘é€æˆåŠŸé€šçŸ¥é‚®ä»¶
      if: success()
      env:
        EMAIL_USER: ${{ secrets.EMAIL_USER }}
        EMAIL_PASSWORD: ${{ secrets.EMAIL_PASSWORD }}
        EMAIL_RECIPIENTS: ${{ vars.EMAIL_RECIPIENTS || secrets.EMAIL_RECIPIENTS }}
        SMTP_SERVER: ${{ vars.SMTP_SERVER || 'smtp.gmail.com' }}
        SMTP_PORT: ${{ vars.SMTP_PORT || '587' }}
      run: |
        if [ -n "$EMAIL_USER" ] && [ -n "$EMAIL_PASSWORD" ] && [ -n "$EMAIL_RECIPIENTS" ]; then
          LATEST_DIR=$(find results -name "20*" -type d | sort | tail -1)
          DATE_STR=$(basename "$LATEST_DIR" 2>/dev/null || date +%Y-%m-%d)
          python3 << 'EMAIL_SCRIPT'
import smtplib
import os
from email.mime.text import MIMEText
from datetime import datetime

smtp_server = os.getenv('SMTP_SERVER', 'smtp.gmail.com')
smtp_port = int(os.getenv('SMTP_PORT', '587'))
user = os.getenv('EMAIL_USER')
password = os.getenv('EMAIL_PASSWORD')
recipients = [r.strip() for r in os.getenv('EMAIL_RECIPIENTS', '').split(',') if r.strip()]

content = f"""âœ… ARM KVMå‘¨æŠ¥ç”Ÿæˆå®Œæˆ - {os.getenv('DATE_STR', datetime.now().strftime('%Y-%m-%d'))}

ğŸ“Š æ•°æ®åˆ†æå·²å®Œæˆï¼Œè¯¦æƒ…è¯·æŸ¥çœ‹åœ¨çº¿æŠ¥å‘Š

ğŸ”— åœ¨çº¿æŸ¥çœ‹: https://onlinefchen.github.io/kvmarm-robot/reports/{os.getenv('DATE_STR', '')}/
ğŸ  å†å²æŠ¥å‘Š: https://onlinefchen.github.io/kvmarm-robot
ğŸ“§ é‚®ä»¶å½’æ¡£: https://lore.kernel.org/kvmarm/

ğŸ¤– ARM KVMåˆ†ææœºå™¨äºº
ç”Ÿæˆæ—¶é—´: {datetime.now().strftime('%Y-%m-%d %H:%M:%S')} (ä¸œå…«åŒº)
"""

msg = MIMEText(content, 'plain', 'utf-8')
msg['Subject'] = f'âœ… ARM KVMå‘¨æŠ¥ - {os.getenv("DATE_STR", datetime.now().strftime("%Y-%m-%d"))}'
msg['From'] = user
msg['To'] = ', '.join(recipients)

try:
    with smtplib.SMTP(smtp_server, smtp_port) as server:
        server.starttls()
        server.login(user, password)
        server.send_message(msg)
    print('âœ… æˆåŠŸé€šçŸ¥é‚®ä»¶å·²å‘é€')
except Exception as e:
    print(f'âŒ é‚®ä»¶å‘é€å¤±è´¥: {e}')
EMAIL_SCRIPT
          export DATE_STR="$DATE_STR"
        else
          echo "âš ï¸ é‚®ä»¶é…ç½®ä¸å®Œæ•´ï¼Œè·³è¿‡é‚®ä»¶é€šçŸ¥"
        fi
    
    - name: ğŸ’¥ å‘é€å¤±è´¥é€šçŸ¥
      if: failure()
      env:
        EMAIL_USER: ${{ secrets.EMAIL_USER }}
        EMAIL_PASSWORD: ${{ secrets.EMAIL_PASSWORD }}
        EMAIL_RECIPIENTS: ${{ vars.EMAIL_RECIPIENTS || secrets.EMAIL_RECIPIENTS }}
        GITHUB_RUN_ID: ${{ github.run_id }}
      run: |
        if [ -n "$EMAIL_USER" ] && [ -n "$EMAIL_PASSWORD" ] && [ -n "$EMAIL_RECIPIENTS" ]; then
          python3 << 'FAILURE_EMAIL_SCRIPT'
import smtplib
import os
from email.mime.text import MIMEText
from datetime import datetime

smtp_server = os.getenv('SMTP_SERVER', 'smtp.gmail.com')
smtp_port = int(os.getenv('SMTP_PORT', '587'))
user = os.getenv('EMAIL_USER')
password = os.getenv('EMAIL_PASSWORD')
recipients = [r.strip() for r in os.getenv('EMAIL_RECIPIENTS', '').split(',') if r.strip()]
run_id = os.getenv('GITHUB_RUN_ID', '')

content = f"""âŒ ARM KVMé‚®ä»¶åˆ†æå¤±è´¥

ğŸ“… æ—¶é—´: {datetime.now().strftime('%Y-%m-%d %H:%M:%S')} (ä¸œå…«åŒº)
ğŸ”— æŸ¥çœ‹è¯¦æƒ…: https://github.com/onlinefchen/kvmarm-robot/actions/runs/{run_id}

è¯·æ£€æŸ¥GitHub Actionsæ—¥å¿—æ’æŸ¥é—®é¢˜ã€‚

---
ğŸ¤– ARM KVMåˆ†ææœºå™¨äºº"""

msg = MIMEText(content, 'plain', 'utf-8')
msg['Subject'] = f'âŒ ARM KVMå‘¨æŠ¥ç”Ÿæˆå¤±è´¥ - {datetime.now().strftime("%Y-%m-%d")}'
msg['From'] = user
msg['To'] = ', '.join(recipients)

try:
    with smtplib.SMTP(smtp_server, smtp_port) as server:
        server.starttls()
        server.login(user, password)
        server.send_message(msg)
    print('ğŸ“§ å¤±è´¥é€šçŸ¥é‚®ä»¶å·²å‘é€')
except Exception as e:
    print(f'âŒ å¤±è´¥é€šçŸ¥å‘é€å¤±è´¥: {e}')
FAILURE_EMAIL_SCRIPT
        else
          echo "âš ï¸ é‚®ä»¶é…ç½®ä¸å®Œæ•´ï¼Œè·³è¿‡å¤±è´¥é€šçŸ¥"
        fi