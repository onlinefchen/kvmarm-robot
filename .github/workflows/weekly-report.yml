name: ARM KVM Weekly Report

on:
  schedule:
    # æ¯å‘¨ä¸€æ—©ä¸Š9ç‚¹ (UTC) è¿è¡Œ
    - cron: '0 9 * * 1'
  
  # å…è®¸æ‰‹åŠ¨è§¦å‘
  workflow_dispatch:
    inputs:
      since:
        description: 'å¼€å§‹æ—¥æœŸ (YYYY-MM-DD)'
        required: false
        type: string
      until:
        description: 'ç»“æŸæ—¥æœŸ (YYYY-MM-DD)'
        required: false
        type: string
      send_notifications:
        description: 'å‘é€é€šçŸ¥'
        required: false
        type: boolean
        default: true

jobs:
  analyze-and-notify:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
        cache: 'pip'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
    
    - name: Configure Git (required for repository cloning)
      run: |
        git config --global user.name "ARM KVM Analyzer"
        git config --global user.email "analyzer@example.com"
    
    - name: Run ARM KVM analysis
      env:
        # AI Provider Configuration
        OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        AI_PROVIDER: openai
        
        # Notification Platform Configurations
        ENABLE_LARK: ${{ vars.ENABLE_LARK }}
        LARK_WEBHOOK_URL: ${{ secrets.LARK_WEBHOOK_URL }}
        LARK_WEBHOOK_SECRET: ${{ secrets.LARK_WEBHOOK_SECRET }}
        
        ENABLE_TELEGRAM: ${{ vars.ENABLE_TELEGRAM }}
        TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
        TELEGRAM_CHAT_ID: ${{ vars.TELEGRAM_CHAT_ID }}
        
        ENABLE_EMAIL: ${{ vars.ENABLE_EMAIL }}
        EMAIL_USER: ${{ secrets.EMAIL_USER }}
        EMAIL_PASSWORD: ${{ secrets.EMAIL_PASSWORD }}
        EMAIL_RECIPIENTS: ${{ vars.EMAIL_RECIPIENTS }}
        SMTP_SERVER: ${{ vars.SMTP_SERVER || 'smtp.gmail.com' }}
        SMTP_PORT: ${{ vars.SMTP_PORT || '587' }}
        
        # System Configuration
        DEFAULT_LANGUAGE: zh
        VERIFY_COMPLETENESS: true
        DEBUG: false
      
      run: |
        # æ„å»ºå‘½ä»¤è¡Œå‚æ•°
        CMD_ARGS="python analyze.py main"
        
        # å¦‚æœæ‰‹åŠ¨è§¦å‘ä¸”æŒ‡å®šäº†æ—¥æœŸèŒƒå›´
        if [ "${{ github.event.inputs.since }}" != "" ] && [ "${{ github.event.inputs.until }}" != "" ]; then
          CMD_ARGS="$CMD_ARGS --since ${{ github.event.inputs.since }} --until ${{ github.event.inputs.until }}"
        fi
        
        # å¦‚æœå¯ç”¨äº†é€šçŸ¥å‘é€
        if [ "${{ github.event.inputs.send_notifications }}" = "true" ] || [ "${{ github.event_name }}" = "schedule" ]; then
          CMD_ARGS="$CMD_ARGS --send-notifications"
        fi
        
        # æ‰§è¡Œåˆ†æ
        echo "ğŸš€ æ‰§è¡Œå‘½ä»¤: $CMD_ARGS"
        $CMD_ARGS
    
    - name: Upload analysis results
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: arm-kvm-analysis-results
        path: results/
        retention-days: 30
    
    - name: Test notification platforms (if analysis failed)
      if: failure()
      env:
        ENABLE_LARK: ${{ vars.ENABLE_LARK }}
        LARK_WEBHOOK_URL: ${{ secrets.LARK_WEBHOOK_URL }}
        ENABLE_TELEGRAM: ${{ vars.ENABLE_TELEGRAM }}
        TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
        TELEGRAM_CHAT_ID: ${{ vars.TELEGRAM_CHAT_ID }}
        ENABLE_EMAIL: ${{ vars.ENABLE_EMAIL }}
        EMAIL_USER: ${{ secrets.EMAIL_USER }}
        EMAIL_PASSWORD: ${{ secrets.EMAIL_PASSWORD }}
        EMAIL_RECIPIENTS: ${{ vars.EMAIL_RECIPIENTS }}
      run: |
        echo "âŒ åˆ†æå¤±è´¥ï¼Œæµ‹è¯•é€šçŸ¥å¹³å°è¿é€šæ€§..."
        python analyze.py notify test-platforms
    
    - name: Send failure notification
      if: failure()
      env:
        ENABLE_TELEGRAM: ${{ vars.ENABLE_TELEGRAM }}
        TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
        TELEGRAM_CHAT_ID: ${{ vars.TELEGRAM_CHAT_ID }}
      run: |
        if [ "$ENABLE_TELEGRAM" = "true" ]; then
          curl -X POST "https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage" \
            -H "Content-Type: application/json" \
            -d "{
              \"chat_id\": \"${TELEGRAM_CHAT_ID}\",
              \"text\": \"âŒ ARM KVMé‚®ä»¶åˆ—è¡¨åˆ†æå¤±è´¥\\n\\nğŸ“… æ—¶é—´: $(date)\\nğŸ”— æŸ¥çœ‹è¯¦æƒ…: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}\",
              \"parse_mode\": \"Markdown\"
            }"
        fi

  # å¯é€‰ï¼šéƒ¨ç½²åˆ°GitHub Pages
  deploy-reports:
    runs-on: ubuntu-latest
    needs: analyze-and-notify
    if: success() && github.event_name == 'schedule'
    
    permissions:
      contents: read
      pages: write
      id-token: write
    
    steps:
    - name: Download analysis results
      uses: actions/download-artifact@v4
      with:
        name: arm-kvm-analysis-results
        path: results/
    
    - name: Setup Pages
      uses: actions/configure-pages@v4
    
    - name: Create index page
      run: |
        mkdir -p public
        cat > public/index.html << 'EOF'
        <!DOCTYPE html>
        <html>
        <head>
            <title>ARM KVM é‚®ä»¶åˆ—è¡¨åˆ†ææŠ¥å‘Š</title>
            <meta charset="utf-8">
            <style>
                body { font-family: Arial, sans-serif; margin: 40px; }
                .header { text-align: center; margin-bottom: 40px; }
                .reports { display: grid; gap: 20px; }
                .report-card { border: 1px solid #ddd; padding: 20px; border-radius: 8px; }
                .report-card h3 { margin-top: 0; color: #007acc; }
                .report-links a { margin-right: 15px; text-decoration: none; color: #007acc; }
                .report-links a:hover { text-decoration: underline; }
            </style>
        </head>
        <body>
            <div class="header">
                <h1>ğŸ“Š ARM KVM é‚®ä»¶åˆ—è¡¨åˆ†ææŠ¥å‘Š</h1>
                <p>è‡ªåŠ¨ç”Ÿæˆçš„å‘¨æŠ¥å’Œåˆ†æç»“æœ</p>
            </div>
            
            <div class="reports">
        EOF
        
        # éå†ç»“æœç›®å½•ï¼Œç”ŸæˆæŠ¥å‘Šé“¾æ¥
        for dir in results/*/; do
          if [ -d "$dir" ]; then
            date=$(basename "$dir")
            echo "                <div class=\"report-card\">" >> public/index.html
            echo "                    <h3>ğŸ“… $date</h3>" >> public/index.html
            echo "                    <div class=\"report-links\">" >> public/index.html
            
            # æ£€æŸ¥å„ç§æŠ¥å‘Šæ–‡ä»¶
            if [ -f "$dir/interactive_report.html" ]; then
              echo "                        <a href=\"results/$date/interactive_report.html\">ğŸ“± äº¤äº’å¼æŠ¥å‘Š</a>" >> public/index.html
            fi
            if [ -f "$dir/analysis_report_zh.md" ]; then
              echo "                        <a href=\"results/$date/analysis_report_zh.md\">ğŸ“„ ä¸­æ–‡æŠ¥å‘Š</a>" >> public/index.html
            fi
            if [ -f "$dir/weekly_report.txt" ]; then
              echo "                        <a href=\"results/$date/weekly_report.txt\">ğŸ“‹ å‘¨æŠ¥</a>" >> public/index.html
            fi
            if [ -f "$dir/statistics.json" ]; then
              echo "                        <a href=\"results/$date/statistics.json\">ğŸ“Š ç»Ÿè®¡æ•°æ®</a>" >> public/index.html
            fi
            
            echo "                    </div>" >> public/index.html
            echo "                </div>" >> public/index.html
          fi
        done
        
        cat >> public/index.html << 'EOF'
            </div>
            
            <div style="margin-top: 40px; text-align: center; color: #666;">
                <p>ğŸ¤– ç”± ARM KVM Mail Analyzer è‡ªåŠ¨ç”Ÿæˆ</p>
                <p>ğŸ“… æœ€åæ›´æ–°: $(date)</p>
            </div>
        </body>
        </html>
        EOF
        
        # å¤åˆ¶ç»“æœæ–‡ä»¶
        cp -r results public/
    
    - name: Upload to Pages
      uses: actions/upload-pages-artifact@v3
      with:
        path: public/
    
    - name: Deploy to Pages
      uses: actions/deploy-pages@v4